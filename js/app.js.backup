// å…¨å±€è®Šæ•¸
let map;
let markers = [];
let supermarketMarkers = [];  // ç¨ç«‹çš„è¶…å¸‚æ¨™è¨˜é™£åˆ—
let shoppingMarkers = [];     // ç¨ç«‹çš„è³¼ç‰©åº—æ¨™è¨˜é™£åˆ—
let souvenirMarkers = [];     // ç¨ç«‹çš„ä¼´æ‰‹ç¦®åº—æ¨™è¨˜é™£åˆ—
let currentDay = 1;
let currentCategory = 'all';
let currentMealType = 'all';

// åˆå§‹åŒ–æ‡‰ç”¨
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    renderDaySelector();
    
    // è¨­ç½®åˆå§‹èƒŒæ™¯åœ–
    const heroSection = document.querySelector('.hero-section');
    const day1Data = itineraryData[1];
    if (day1Data.bgImage) {
        heroSection.style.backgroundImage = `url('${day1Data.bgImage}')`;
    }
    
    // æ·»åŠ æ°¸ä¹…è¶…å¸‚æ¨™è¨˜
    addSupermarketMarkers();
    
    // æ·»åŠ æ°¸ä¹…è³¼ç‰©åº—æ¨™è¨˜
    addShoppingMarkers();
    
    // æ·»åŠ æ°¸ä¹…ä¼´æ‰‹ç¦®åº—æ¨™è¨˜
    addSouvenirMarkers();
    
    showDay(1);
});

// åˆå§‹åŒ–åœ°åœ–
function initMap() {
    map = L.map('map').setView([38.2682, 140.8694], 11);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap Â© CARTO',
        maxZoom: 19
    }).addTo(map);
}

// æ¸²æŸ“å¤©æ•¸é¸æ“‡å™¨
function renderDaySelector() {
    const daySelectorDiv = document.getElementById('day-selector');
    
    daysConfig.forEach(config => {
        const dayCard = document.createElement('div');
        dayCard.className = 'day-card';
        if (config.day === 1) {
            dayCard.classList.add('active');
        }
        
        dayCard.innerHTML = `
            <div class="day-label">${config.label}</div>
            <div class="day-date">${config.date}</div>
            <div class="day-weather">${config.weather}</div>
        `;
        
        dayCard.addEventListener('click', () => {
            currentCategory = 'all';
            currentMealType = 'all';
            showDay(config.day);
        });
        daySelectorDiv.appendChild(dayCard);
    });
}

// é¡¯ç¤ºæŒ‡å®šå¤©æ•¸çš„è¡Œç¨‹
function showDay(day) {
    currentDay = day;
    
    // æ›´æ–°å¤©æ•¸å¡ç‰‡æ¨£å¼
    const dayCards = document.querySelectorAll('.day-card');
    dayCards.forEach((card, index) => {
        card.classList.toggle('active', index + 1 === day);
    });

    // æ¸…é™¤èˆŠæ¨™è¨˜
    clearMarkers();

    // ç²å–ç•¶å¤©è¡Œç¨‹æ•¸æ“š
    const dayData = itineraryData[day];
    
    // æ›´æ–° Hero Section èƒŒæ™¯åœ–
    const heroSection = document.querySelector('.hero-section');
    if (dayData.bgImage) {
        heroSection.style.backgroundImage = `url('${dayData.bgImage}')`;
    }
    
    // æ¸²æŸ“è¡Œç¨‹
    renderItinerary(dayData);
    
    // æ·»åŠ åœ°åœ–æ¨™è¨˜
    addMapMarkers(dayData);
    
    // æ»¾å‹•åˆ°è¡Œç¨‹å…§å®¹
    setTimeout(() => {
        document.getElementById('itinerary-container').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'nearest' 
        });
    }, 100);
}

// æ¸²æŸ“è¡Œç¨‹å…§å®¹
function renderItinerary(dayData) {
    let html = `
        <div class="day-header fade-in">
            <h2>${dayData.title}</h2>
            <div class="day-meta">
                <div class="day-meta-item">ğŸ“… ${dayData.date}</div>
                <div class="day-meta-item">ğŸ“ ${dayData.location}</div>
            </div>
        </div>
    `;

    // é£¯åº—è³‡è¨Šå¡ï¼ˆå¦‚æœæœ‰ï¼‰
    if (dayData.hotel) {
        html += `
            <div class="hotel-card-inline fade-in">
                ${dayData.hotel.image ? `<img src="${dayData.hotel.image}" alt="${dayData.hotel.name}">` : ''}
                <h4>ğŸ¨ ä»Šæ™šä½å®¿</h4>
                <div style="font-weight: 700; font-size: 1.1rem; margin: 0.5rem 0;">${dayData.hotel.name}</div>
                <div style="color: var(--text-gray); margin-bottom: 0.5rem;">
                    ğŸ“ ${dayData.hotel.location} | Check-in: ${dayData.hotel.checkIn}
                    ${dayData.hotel.dates ? `<br>ğŸ“… ä½å®¿æœŸé–“: ${dayData.hotel.dates}` : ''}
                </div>
                <div class="hotel-features">
                    ${dayData.hotel.features.map(f => `<div class="hotel-feature">${f}</div>`).join('')}
                </div>
            </div>
        `;
    }

    // åˆ†é¡ç¯©é¸æŒ‰éˆ•
    html += `<div class="category-filters">`;
    for (const [key, cat] of Object.entries(categories)) {
        const active = currentCategory === key ? 'active' : '';
        html += `
            <button class="category-btn ${active}" onclick="filterByCategory('${key}')">
                ${cat.icon} ${cat.label}
            </button>
        `;
    }
    html += `</div>`;

    // ç”¨é¤æ™‚æ®µç¯©é¸æŒ‰éˆ•ï¼ˆåªåœ¨æœ‰é¤å»³çš„å¤©æ•¸é¡¯ç¤ºï¼‰
    const hasRestaurants = dayData.locations.some(loc => loc.category === 'restaurant');
    if (hasRestaurants) {
        html += `<div class="meal-filters">`;
        for (const [key, meal] of Object.entries(mealTypes)) {
            const active = currentMealType === key ? 'active' : '';
            html += `
                <button class="meal-btn ${active}" onclick="filterByMeal('${key}')">
                    ${meal.icon} ${meal.label}
                </button>
            `;
        }
        html += `</div>`;
    }

    // æ™‚é–“è»¸
    html += `<div class="timeline">`;
    dayData.locations.forEach((loc, index) => {
        const shouldShow = shouldShowLocation(loc);
        const hiddenClass = shouldShow ? '' : 'hidden';
        
        html += `
            <div class="timeline-item ${hiddenClass}" data-category="${loc.category}" data-meal="${loc.mealType || 'none'}">
                <div class="timeline-dot">${index + 1}</div>
                <div class="timeline-time">${loc.time}</div>
                <div class="timeline-content">
                    <div class="timeline-title">${loc.name}</div>
                    <div class="timeline-desc">${loc.desc}</div>
                    <div class="timeline-tags">
                        ${loc.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    });
    html += `</div>`;

    document.getElementById('itinerary-container').innerHTML = html;
}

// åˆ¤æ–·æ˜¯å¦æ‡‰è©²é¡¯ç¤ºè©²åœ°é»
function shouldShowLocation(location) {
    // åˆ†é¡ç¯©é¸
    if (currentCategory !== 'all' && location.category !== currentCategory) {
        return false;
    }
    
    // ç”¨é¤æ™‚æ®µç¯©é¸
    if (currentMealType !== 'all') {
        if (location.mealType !== currentMealType) {
            return false;
        }
    }
    
    return true;
}

// æŒ‰åˆ†é¡ç¯©é¸
function filterByCategory(category) {
    currentCategory = category;
    const dayData = itineraryData[currentDay];
    renderItinerary(dayData);
    updateMapMarkers(dayData);
}

// æŒ‰ç”¨é¤æ™‚æ®µç¯©é¸
function filterByMeal(mealType) {
    currentMealType = mealType;
    const dayData = itineraryData[currentDay];
    renderItinerary(dayData);
    updateMapMarkers(dayData);
}

// æ›´æ–°åœ°åœ–æ¨™è¨˜ï¼ˆæ ¹æ“šç¯©é¸ï¼‰
function updateMapMarkers(dayData) {
    clearMarkers();
    addMapMarkers(dayData);
}

// æ¸…é™¤åœ°åœ–æ¨™è¨˜
function clearMarkers() {
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
}

// æ·»åŠ åœ°åœ–æ¨™è¨˜
function addMapMarkers(dayData) {
    const validLocations = dayData.locations.filter(loc => {
        return loc.coords && shouldShowLocation(loc);
    });
    
    if (validLocations.length === 0) return;
    
    validLocations.forEach((loc, index) => {
        // æ ¹æ“šåˆ†é¡é¸æ“‡é¡è‰²
        const color = getCategoryColor(loc.category);
        
        // å‰µå»ºè‡ªå®šç¾©åœ–æ¨™
        const customIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                background: ${color};
                color: white;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 14px;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            ">${index + 1}</div>`,
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
        
        const marker = L.marker(loc.coords, { icon: customIcon }).addTo(map);
        
        // å½ˆå‡ºçª—å£
        const categoryLabel = categories[loc.category].label;
        let popupContent = `
            <div style="font-family: 'Noto Sans TC', sans-serif; min-width: 200px;">
                <h4 style="color: ${color}; margin-bottom: 0.5rem; font-size: 1.1rem;">${loc.name}</h4>
                <p style="margin: 0; color: #6b6b6b; font-size: 0.85rem;">
                    <strong>${loc.time}</strong> | ${categoryLabel}
                </p>
                <p style="margin: 0.5rem 0 0; color: #2d2d2d; font-size: 0.9rem; line-height: 1.5;">
                    ${loc.desc}
                </p>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });

    // èª¿æ•´åœ°åœ–è¦–è§’
    if (validLocations.length > 0) {
        const bounds = L.latLngBounds(validLocations.map(loc => loc.coords));
        map.fitBounds(bounds, { 
            padding: [50, 50], 
            maxZoom: validLocations.length === 1 ? 14 : 13 
        });
    }
}

// æ ¹æ“šåˆ†é¡ç²å–é¡è‰²
function getCategoryColor(category) {
    const colors = {
        attraction: '#8b6f47',
        restaurant: '#d47474',
        shopping: '#c9a961',
        specialty: '#a97c50',
        market: '#6ba985'
    };
    return colors[category] || '#8b6f47';
}

// è™•ç†è¦–çª—å¤§å°è®ŠåŒ–
window.addEventListener('resize', function() {
    if (map) {
        map.invalidateSize();
    }
});

// æ·»åŠ æ°¸ä¹…è¶…å¸‚æ¨™è¨˜
function addSupermarketMarkers() {
    supermarkets.forEach((market) => {
        // å‰µå»ºè¶…å¸‚å°ˆç”¨åœ–æ¨™
        const supermarketIcon = L.divIcon({
            className: 'custom-marker supermarket-marker',
            html: `<div style="
                background: #6ba985;
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                border: 3px solid white;
                box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            ">ğŸ›’</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        const marker = L.marker(market.coords, { icon: supermarketIcon }).addTo(map);
        
        // å½ˆå‡ºçª—å£ - ä½¿ç”¨è¼”åŠ©å‡½æ•¸
        const popupContent = createStorePopupWithGoogleMaps(market, '#6ba985');
        
        marker.bindPopup(popupContent);
        supermarketMarkers.push(market);
    });
}

// æ·»åŠ æ°¸ä¹…è³¼ç‰©åº—æ¨™è¨˜
function addShoppingMarkers() {
    shoppingStores.forEach((store) => {
        // å‰µå»ºè³¼ç‰©åº—å°ˆç”¨åœ–æ¨™
        const shoppingIcon = L.divIcon({
            className: 'custom-marker shopping-marker',
            html: `<div style="
                background: #c9a961;
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                border: 3px solid white;
                box-shadow: 0 3px 10px rgba(212, 165, 116, 0.5);
            ">ğŸ›ï¸</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        const marker = L.marker(store.coords, { icon: shoppingIcon }).addTo(map);
        
        // å½ˆå‡ºçª—å£
        let popupContent = `
            <div style="font-family: 'Noto Sans TC', sans-serif; min-width: 220px;">
                <h4 style="color: #c9a961; margin-bottom: 0.5rem; font-size: 1.1rem;">${store.name}</h4>
                <p style="margin: 0.5rem 0; color: #2d2d2d; font-size: 0.9rem; line-height: 1.5;">
                    ${store.desc}
                </p>
                ${store.hours ? `<p style="margin: 0.5rem 0; color: #c9a961; font-size: 0.9rem; font-weight: 600;">â° ${store.hours}</p>` : ''}
                <div style="margin-top: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.4rem;">
                    ${store.tags.map(tag => `
                        <span style="background: #f5f1eb; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #e5dfd5;">
                            ${tag}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        shoppingMarkers.push(marker);
    });
}

// æ·»åŠ æ°¸ä¹…ä¼´æ‰‹ç¦®åº—æ¨™è¨˜
function addSouvenirMarkers() {
    souvenirStores.forEach((store) => {
        // å‰µå»ºä¼´æ‰‹ç¦®åº—å°ˆç”¨åœ–æ¨™
        const souvenirIcon = L.divIcon({
            className: 'custom-marker souvenir-marker',
            html: `<div style="
                background: #daa65f;
                color: white;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                border: 3px solid white;
                box-shadow: 0 3px 10px rgba(218, 166, 95, 0.5);
            ">ğŸ</div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        
        const marker = L.marker(store.coords, { icon: souvenirIcon }).addTo(map);
        
        // å½ˆå‡ºçª—å£
        let popupContent = `
            <div style="font-family: 'Noto Sans TC', sans-serif; min-width: 220px;">
                <h4 style="color: #daa65f; margin-bottom: 0.5rem; font-size: 1.1rem;">${store.name}</h4>
                <p style="margin: 0.5rem 0; color: #2d2d2d; font-size: 0.9rem; line-height: 1.5;">
                    ${store.desc}
                </p>
                ${store.hours ? `<p style="margin: 0.5rem 0; color: #daa65f; font-size: 0.9rem; font-weight: 600;">â° ${store.hours}</p>` : ''}
                <div style="margin-top: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.4rem;">
                    ${store.tags.map(tag => `
                        <span style="background: #f5f1eb; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #e5dfd5;">
                            ${tag}
                        </span>
                    `).join('')}
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        souvenirMarkers.push(marker);
    });
}
// ==================== åº—å®¶æ¸…å–®åŠŸèƒ½ ====================

// åˆ‡æ›åˆ†é¡ç¯©é¸ä¸¦é¡¯ç¤ºåº—å®¶æ¸…å–®
function toggleCategoryFilter(category) {
    const container = document.getElementById('store-list-container');
    const title = document.getElementById('store-list-title');
    const content = document.getElementById('store-list-content');
    
    // æ›´æ–°åœ–ä¾‹æ¨£å¼
    document.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('active');
    });
    const activeItem = document.querySelector(`[data-category="${category}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
    
    // å¦‚æœé»æ“Š"å…¨éƒ¨æ™¯é»"ï¼Œéš±è—åº—å®¶æ¸…å–®
    if (category === 'all' || category === 'attraction' || category === 'restaurant') {
        container.style.display = 'none';
        return;
    }
    
    // æ”¶é›†è©²åˆ†é¡çš„æ‰€æœ‰åº—å®¶
    let stores = [];
    let categoryName = '';
    let categoryIcon = '';
    
    switch(category) {
        case 'shopping':
            stores = shoppingStores;
            categoryName = 'è³¼ç‰©åº—';
            categoryIcon = 'ğŸ›ï¸';
            break;
        case 'specialty':
            stores = souvenirStores;
            categoryName = 'ä¼´æ‰‹ç¦® & ç‰¹ç”¢';
            categoryIcon = 'ğŸ';
            break;
        case 'market':
            stores = supermarkets;
            categoryName = 'è¶…å¸‚';
            categoryIcon = 'ğŸ›’';
            break;
    }
    
    // å¦‚æœæ²’æœ‰åº—å®¶ï¼Œä¸é¡¯ç¤º
    if (stores.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    // æ›´æ–°æ¨™é¡Œ
    title.innerHTML = `${categoryIcon} ${categoryName} <span style="color: var(--text-gray); font-size: 0.9rem; font-weight: 400;">(${stores.length} é–“)</span>`;
    
    // ç”Ÿæˆåº—å®¶æ¸…å–®
    content.innerHTML = stores.map((store, index) => `
        <div class="store-item" onclick="focusOnStore(${index}, '${category}')">
            <div class="store-item-name">${store.name}</div>
            <div class="store-item-desc">${store.desc || ''}</div>
            <div class="store-item-tags">
                ${(store.tags || []).map(tag => `<span class="store-item-tag">${tag}</span>`).join('')}
            </div>
        </div>
    `).join('');
    
    // é¡¯ç¤ºæ¸…å–®
    container.style.display = 'block';
    
    // å¹³æ»‘æ»¾å‹•åˆ°æ¸…å–®
    setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// èšç„¦åˆ°ç‰¹å®šåº—å®¶
function focusOnStore(index, category) {
    let stores = [];
    let markers = [];
    
    switch(category) {
        case 'shopping':
            stores = shoppingStores;
            markers = shoppingMarkers;
            break;
        case 'specialty':
            stores = souvenirStores;
            markers = souvenirMarkers;
            break;
        case 'market':
            stores = supermarkets;
            markers = supermarketMarkers;
            break;
    }
    
    if (markers[index]) {
        // èšç„¦åœ°åœ–åˆ°è©²æ¨™è¨˜
        map.setView(stores[index].coords, 16);
        // æ‰“é–‹å½ˆå‡ºçª—å£
        markers[index].openPopup();
        
        // å¹³æ»‘æ»¾å‹•å›åœ°åœ–
        document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// é—œé–‰åº—å®¶æ¸…å–®
function closeStoreList() {
    const container = document.getElementById('store-list-container');
    container.style.display = 'none';
    
    // é‡ç½®åœ–ä¾‹æ¨£å¼
    document.querySelectorAll('.legend-item').forEach(item => {
        item.classList.remove('active');
    });
}

// é¡¯ç¤ºæ°¸ä¹…åº—å®¶æ¸…å–®
function showPermanentStores(type) {
    const listContainer = document.getElementById('permanent-stores-list');
    const buttons = document.querySelectorAll('.store-filter-btn');
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    buttons.forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    // æ”¶é›†è¦é¡¯ç¤ºçš„åº—å®¶
    let stores = [];
    let icon = '';
    
    if (type === 'all' || type === 'supermarket') {
        supermarkets.forEach(store => {
            stores.push({...store, icon: 'ğŸ›’', type: 'è¶…å¸‚'});
        });
    }
    
    if (type === 'all' || type === 'shopping') {
        shoppingStores.forEach(store => {
            stores.push({...store, icon: 'ğŸ›ï¸', type: 'è³¼ç‰©åº—'});
        });
    }
    
    if (type === 'all' || type === 'souvenir') {
        souvenirStores.forEach(store => {
            stores.push({...store, icon: 'ğŸ', type: 'ä¼´æ‰‹ç¦®'});
        });
    }
    
    // ç”Ÿæˆ HTML
    if (stores.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; color: var(--text-gray); padding: 2rem;">æ²’æœ‰åº—å®¶è³‡æ–™</div>';
        listContainer.classList.remove('hidden');
        return;
    }
    
    let html = '<div class="stores-grid">';
    
    stores.forEach(store => {
        const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}`;
        html += `
            <div class="store-item">
                <div class="store-item-header">
                    <span class="store-icon">${store.icon}</span>
                    <a href="${googleMapsUrl}" target="_blank" class="store-name store-name-link" onclick="event.stopPropagation();">${store.name}</a>
                </div>
                <div class="store-desc">${store.desc}</div>
                ${store.hours ? `<div style="color: var(--primary); font-size: 0.9rem; margin-bottom: 0.5rem;">â° ${store.hours}</div>` : ''}
                <div class="store-tags">
                    ${store.tags.map(tag => `<span class="store-tag">${tag}</span>`).join('')}
                </div>
                <button class="store-map-btn" onclick="focusOnStore(${store.coords[0]}, ${store.coords[1]}, '${store.name}')">
                    ğŸ“ åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    
    listContainer.innerHTML = html;
    listContainer.classList.remove('hidden');
    
    // æ»¾å‹•åˆ°æ¸…å–®ä½ç½®
    listContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// èšç„¦åˆ°åº—å®¶ä½ç½®
function focusOnStore(lat, lng, name) {
    if (map) {
        map.setView([lat, lng], 16);
        // æ‰¾åˆ°å°æ‡‰çš„æ¨™è¨˜ä¸¦æ‰“é–‹å½ˆå‡ºçª—å£
        const allMarkers = [...supermarketMarkers, ...shoppingMarkers, ...souvenirMarkers, ...markers];
        allMarkers.forEach(marker => {
            if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lng) {
                marker.openPopup();
            }
        });
    }
}

// åˆ‡æ›æ—…è¡Œå·¥å…·é¢æ¿
function toggleToolsPanel() {
    const panel = document.getElementById('tools-panel');
    panel.classList.toggle('active');
}

// é»æ“Šé¢æ¿å¤–éƒ¨é—œé–‰
document.addEventListener('click', function(event) {
    const panel = document.getElementById('tools-panel');
    const toggleBtn = document.querySelector('.tools-toggle-btn');
    
    if (panel && panel.classList.contains('active')) {
        if (!panel.contains(event.target) && !toggleBtn.contains(event.target)) {
            panel.classList.remove('active');
        }
    }
});
// ç‚ºå½ˆå‡ºçª—å£æ·»åŠ  Google åœ°åœ–é€£çµçš„è¼”åŠ©å‡½æ•¸
function createStorePopupWithGoogleMaps(store, color) {
    const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.name)}`;
    return `
        <div style="font-family: 'Noto Sans TC', sans-serif; min-width: 220px;">
            <h4 style="color: ${color}; margin-bottom: 0.5rem; font-size: 1.1rem;">${store.name}</h4>
            <p style="margin: 0.5rem 0; color: #2d2d2d; font-size: 0.9rem; line-height: 1.5;">
                ${store.desc}
            </p>
            ${store.hours ? `<p style="margin: 0.5rem 0; color: ${color}; font-size: 0.9rem; font-weight: 600;">â° ${store.hours}</p>` : ''}
            <div style="margin-top: 0.8rem; display: flex; flex-wrap: wrap; gap: 0.4rem;">
                ${store.tags.map(tag => `
                    <span style="background: #f5f1eb; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.8rem; border: 1px solid #e5dfd5;">
                        ${tag}
                    </span>
                `).join('')}
            </div>
            <a href="${googleMapsUrl}" target="_blank" style="
                display: block;
                margin-top: 1rem;
                padding: 0.6rem 1rem;
                background: ${color};
                color: white;
                text-align: center;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                transition: opacity 0.3s;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                ğŸ—ºï¸ åœ¨ Google åœ°åœ–ä¸­é–‹å•Ÿ
            </a>
        </div>
    `;
}
